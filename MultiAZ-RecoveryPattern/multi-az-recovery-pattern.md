# Multi-AZ recovery patterns

- from: https://docs.aws.amazon.com/ko_kr/whitepapers/latest/advanced-multi-az-resilience-patterns/multi-az-recovery-patterns.html

- 단일 AZ에서 영향을 확인하고 나면 복구는 가용영역 독립성 (AZI) 형태를 구현하는 것으로 목표로 한다. 
- 또한 가끔 Availability Zone Affinity 라고 부른다. 이는 트래픽을 AZ 레벨에 고립할 수 있도록 하는 것이다. 
- 트래픽이 가용 영역 경계를 넘지 않도록 보장하므로, 고객이 생성한 트래픽이 영향을 받는 가용 영역으로 전송되는 것을 막을 수 있을 뿐만 아니라, 정상적인 가용 영역의 리소스가 영향을 받는 가용 영역의 다른 리소스와 상호작용 하는 것을 방지할 수 있다. 
- (예를 들어 EC2 인스턴스가 영향을 받는 가용 영역의 인터페이스 VPC 엔드포인트로 트래픽을 보내는 경우)
- 워크로드가 이미 AZI로 설계된 경우 가용 영역 제거 프로세스가 더 간단해진다. 

<br/>

- 영향을 받는 가용 영역으로 라우팅 작업을 방지하는 것 이외에도 해당 가용 영역에서 새 용량이 프로비저닝 되는 것을 중지해야한다. 
- 두번째 단계는 중요하다. 새로운 용량이 영향을 받는 가용 영역에서 시작되는 경우, 기존 용량과 동일한 영향을 받을 수 있으므로, 프로비저닝된 로드를 처리하기 위해 부하를 흡수할 수 없음을 말한다. 
- 이로 인해 기존 리소스에 대한 부하가 증가하여 워크로드의 "부족" 또는 완전한 비가용성으로 이어질 수 있다. 
- Amazon EC2 오토 스케일링, 어플리케이션 오토 스케일링 및 AWS 오토스케일링과 같이 AWS에서 사용할 수 있는 몇가지 오토스케일링 서비스가 있다. 
- 추가적으로 Amazon ECS와 Amazon EKS, AWS Batch 와 같은 서비스들은 정상 동작의 일부로 VPC 의 가용 영역에 걸쳐 호스트에 대한 작업을 예약할 수 있다. 

<br/>

- 일부 AWS 서비스는 사용자 정의 다중 AZ 구성을 지원하며, Amazon RDS또는 Amazon Aurora 와 같은 다중 AZ장애 조치 기능이 내장되어 있다. 
- 이러한 서비스에 대해서 AZ에서 영향을 확인하면, 수동으로 failover를 할 수 있다. 
- Amazon Aurora 와 같은 서비스의 경우에서 커스텀 DNS 혹은 커스텀 엔드포인트를 이용하도록 사전 설정을 할 수 있다. 
- 이렇게 하면 이러한 서비스에서 AZI 패턴을 구현하여 가용 영역 대피를 지원할 수 있다. 

<br/>

- 다른 존 서비스에서도 효과적인 AZ 대피를 위해서 AZI 패턴을 사용하여 구현해야한다. 
- 예를 들어, 인터페이스 VPC 엔드포인트는 인터페이스 엔드포인트가 사용 가능한 각 사용영역에 대해 특정 DNS 이름을 제공한다. 
- VPC에서 당신의 워크로드는 AZ 지정 DNS 이름을 엔드포인트에서 사용하도록 구성해야한다. 
- 혹은 이벤트가 발생한 후 영향을 받는 가용 영역으로 VPC 엔드포인트 트래픽이 전송되지 않도록 이 섹션의 패턴을 조정할 수 있다. 
- 이 섹션의 패턴은 NLB(Network Load Balancer)와 같이 미리 정의된 다중 AZ 장애 조치 기능이 없는 서비스를 사용하는 워크로드 구성 요소에 중점을 둔다. 
- ALB(Application Load Balancer) 및 Auto Scaling 그룹과 같은 AZI 적용을 기본저긍로 지원하지 않는다. 

<br/>

- AWS 는 제어 플레인과 데이터 플레인을 구분한다. 
- 제어 플레인은 시스템 변경 (리소스 추가, 리소스 삭제, 리소스 수정)을 수행하고 변경 사항을 적용야 하는 모든 곳으로 전파하는 것과 관련된 기계이다. 
- 이러한 ALB에 대한 네트워크 구성 업데이트 또는 AWS Lambda 함수 생성.

<br/>

- 데이터 플레인들은 이러한 리소스들의 일별 비즈니스이며, 이들은 EC2에서 수행되거나, 혹은 Amazon DynamoDB 테이블에서 항목 가져오기 또는 Amazon DynamoDB 테이블에 항목 넣는것과 같은 리소스의 일상적인 비즈니스이다. 
- 컨트롤 플레인과 데이터 플레인에 대한 상세한 논의는 Static Stability using Availabillity Zones 에서 확인가능하다. http://aws.amazon.com/builders-library/static-stability-using-availability-zones

<br/>

- 이 문서의 목적은 제어 플레인은 데이터 플레인보다 움직이는 부분이 더 많고, 적은 양(종종 수십 배) 에서 작동하는 경향이 있다는 점을 고려하라. 
- 이러한 사실만으로 데이터 플레인에 비해 컨트롤 플레인이 손상될 가능성이 통계적으로 더 높다. 
- 이는 Amazon EC2 및 EBS와 같이 AZI를 제공하는 서비스와 특히 관련이 있다. 
- 제어 플레인도 영역별로 독립적이고 단일 AZ 이벤트 중에 영향을 받을 수 있기 때문이다. 

<br/>

- 제어 평면 작업은 AZI를 구현하는 데 사용할 수 있지만 이전 정보를 기반으로 하면 특히 실패 이벤트 중에 성공 확율이 더 낮을 수 있다. 
- 영향을 성공적으로 완화할 확율을 높이려면 두 가지 다른 패턴을 사용할 수 있다. 
- 첫번째 패턴은 데이터 플레인 작업에만 의존하여 작업이 영향을 받는 가용 영역으로 라우팅 되는 것을 방지하거나 영향을 받는 가용 영역에서 수행되는 작업을 중지하여 영향을 처음에 완화한다. 
- 두번째 패턴은 영향을 받는 가용 영역에서 용량이 프로비저닝되는 것을 방지하고 해당 가용 영역과의 가용 영역 간 통신을 중지하기 위해 제어 플레인 작업으로 리소스 구성을 업데이트 하려고 시도할 수 있다. 

<br/>

- 복구 패턴들은 "큰 빨간색 버튼" 이다. 
- 이들은 조립 라인에서 Andon 코드를 당기는 것과 유사한 대규모 조치를 신속하게 취하는 데 사용하는 메커니즘이다. 
- 이들은 워크로드가 일시적인 오류를 극복하기 위해 코드에 지터가 있는 지수 백오프를 사용하여 재시도하는 것과 같은 전략을 이미 시도했다고 가정한다. 
- 이 의미는 AZI 영향이 발견되면 가용성, 또는 지연 시간에 대한 영향이 충분히 심각하여 효과적으로 완화 하기 위해 가용 영역을 비워야한다. 

