# AWS Lambda 성능 최적화 

## AWS Lambda에서 성능에 영향을 주는 요소

1. Cold Start / Warm Start 개념
   1. Cold Start
      1. 람다 환경 구성 (람다 실행을 위한 코드, 라이브러리 등을 다운로드 받아 실행을 준비하는 시간)
   2. Warm Start
      1. 하나의 람다는 첫번째 요청이 끝나고 바로 자원을 회수하지 않고 일정정도 기다림
      2. 이 기다리는 시간에 재사용되는 경우 Warm Start라고 함 (성능향상)
2. Provisioned Concurrency
   1. https://aws.amazon.com/blogs/compute/new-for-aws-lambda-predictable-start-up-times-with-provisioned-concurrency/
   2. cold start를 줄이기 위해서 사전에 미리 프로비젼을 수행한 Lambda를 생성
   3. 가장 낮은 latency 보장하는 추천 솔루션
   4. 원하는 Provisioned Concurrency 카운트를 설정해주면 초기화시에 cold start 가 카운트만큼 수행하여 프로비저닝 수행
   5. 이후 요청은 생성된 Provisioned Concurrency 를 이용하여 요청 실행 
   6. 참고: 프로비젼 하면 동시성 1개당 최소 2개의 실행 환경이 별도의 가용 영역에 준비됨 
3. 호출 패턴의 개선 
   1. 람다는 한번에 하나의 요청을 처리
   2. 처리가 끝나면 바로 리소스를 반납하지 않고 일정 대기
   3. 대기 중에 새로운 요청이 들어오면 새로운 요청을 처리 
   4. 동시 요청 --> 복수개의 실행 환경 제공하기 위해 스케일업 
   5. 비동기 호출 --> 호출자와 람다 서비스 사이에 내부 대기열 존재
   6. 대기열의 데이터는 람다가 가져가면서 처리 
   7. 만약 예약 용량을 1로 설정하면 --> 순차적으로 이벤트 처리가 수행됨 
4. 메모리 사용량 설정 (128Mb --> 1,024Mb) 로
   1. 비용과 속도 = (시간 * 메모리)
   2. 메모리가 높아지면 성능을 향상 시킬 수 있다. (비용과 성능 사이에 관계로 최적의 메모리 찾기)

|Memory|	Duration|	Cost|
|---|---|---|
|128 MB|	11.722 s|	$0.024628|
|256 MB|	6.678 s|	$0.028035|
|512 MB|	3.194 s|	$0.026830|
|1024 MB|	1.465 s|	$0.024638|

5. Lambda Power Tuning 툴 이용하여 최적화 변수 사용
   1. 각 워크로드에 대해서 메모리량을 다르게 하여 람다를 복수로 실행
   2. 실행이 완료되면 람다에서 최적 성능 메모리 찾아서 사용 (Step Function사용)
   3. https://github.com/alexcasalboni/aws-lambda-power-tuning
   4. 일반적으로 CPU 바운드 람다 함수는 메모리 증가시 가장큰 이점 얻음
   5. 네트워크 바운드는 메모리 증가와 관련이 적음 

6. 정적 초기화 
   1. 정적 초기화 핸들러 코드가 함수 실행전에 발생
   2. 실행코드 다운로드 + 종속성 다운로드 + 타 서비스 연결 초기화 
   3. 종속성 라이브러리 다운로드시 --> 최소한 필요한 라이브러리만 가져오도록 구성하기 

7. 동기/비동기 구분처리
   1. 호출 카운트는 람다 비용과 양의 상관관계 가짐
   2. 그러므로 비동기 처리가 가능한경우 호출 양을 최소화 하고 ColdStart 줄여줄 수 있음 
   3. 비동기 + 웹소켓 연동으로 요청/처리 분리 
   4. CloudFront 등을 이용하여 요청 처리를 캐싱을 이용하거나, 람다 호출량을 줄여주는 방안 고려

8. Lambda 사용하지 않고 처리
   1. API G/W + DB (ex DynamoDB의 VTL이용)
   2. API G/W + 타 REST API
   3. Step Function 이용하기
   
9.  필터링 (이벤트를 필터링 하여 원하는 이벤트에 대해서만 Lambda 실행)
10. 함수 런타임 고려
    1. 정적 컴파일 언어
       1. 초기화 시간은 길수 있음 (Cold start 김 / 기능 실행시 성능향상)
    2. 동적 컴파일 언어
       1. 초기화 시간은 짧음, 많은 반복시 성능 저하
       2. (Cold start 짧음 / 기능 실행시 시간 오래 소요)