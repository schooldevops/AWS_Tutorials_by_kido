# Redis Solutions: Standalone vs Sentinel vs Cluster

from: https://medium.com/hepsiburadatech/redis-solutions-standalone-vs-sentinel-vs-cluster-f46e703307a9

## What is Redis?

- Redis는 고성능 in-memory NoSQL 데이터베이스이고, 캐시이다. 
- 오픈소스이며 C로 작성되어 있고, 빠른 스피드를 위해 설계 되었다. 
- Redis의 의미는 "Remote Dictionary Server"이다. 

<br/>

- 지원 데이터타입은 string, llists, hashes, sets, sorted sets 가 있다. 
- Redis는 데이터 구조 서버로 자주 거론이 된다. 
- 다른 많은 데이터 구조 그리고 geolocation 에 대한 기능과 스트림 처리도 가능하다. 

<br/>

- Redis는 다양한 데이터 구조들을 가지며 프로세스와 서비스들 사이에 쉽게 공유할 수 있는 자연적인 데이터 구조를 사용한다. 
- 이는 빠르게 개발을 진행하고 어플리케이션에 적용할 수 있도록 해준다. 

<br/>

- Redis 는 데이터를 기본적으로 메모리에 저장한다. 
- 주기적으로 디스크에 저장하도록 옵션을 줄 수 있다. 
- 여기에는 2가지 디스크 저장 옵션이 있다. RDB(Redis Database)와 AOF(Append Only File)가 그것이다 .
- 특정 인터벌에서 RDB 는 데이터셋의 스냅샷을 특정 시점정보를 저장한다. 
- AOF는 로그를 서버로 부터 받은 정보로 저장하며 원본 데이터를 다시 구성한다. 

<br/>

- Redis가 꽉 차는것을 방지하기 위해서 TTL(Time to Live)를 설정할 수 있다. 
- 이를 통해서 특정 시간이 지나면, 데이터를 삭제한다. 

<br/>

- 이 아티클은 Standalone Redis, Redis Sentinel을 통한 고가용성, Redis Cluster를 통한 자동 파티셔닝을 다룬다. 
- 이들의 장점과 단점에 대해서 알아볼 것이다. 

## What is a Single Redis Instance

- 이는 단일 Redis 노드를 배포하는 아키텍처이다. 

### 장점

- 단순하고 전통적인 아키텍처이다. 
- 쉽게 배포하고 설정할 수 있다. 

### 단점

- 이는 데이터의 신뢰성이 필요한 경우 적합하지 않다. 
- 여기에는 백업이 없고 (slave) 실시간 데이터 동기화를 수행하지 않는다. 
- Redis 는 단일 쓰레드 메커니즘을 이용하기 때문에 단일 코어 CPU의 처리 능력에 대해서 제한이 따른다. 
- 주요 보틀넥은 CPU이며, 이는 명령의 수에 제약이 가게 된다. 왜냐하면 단일 컴퓨터에서 수행해야하기 때문이다. 

![Standalone](https://miro.medium.com/max/884/0*ImoeLTgBK-e2NRAn)

## Waht is Redis Sentinel?

- Redis 인스턴스를 쉽게 관리하기 위해서 구성되었다. 
- Redis 2.8 부터 Redis Sentinel 가 배포 되었고, 가용성을 가진다. 
- Sentinel 은 분리된 어플리케이션으로 백그라운드로 수행된다. 
- 이는 마스터 노드와 슬레이브 노드를 모니터링 하고, 변경이 발생되면 자동으로 failover 를 수행하여 마스터의 실패를 처리하게 된다. 

<br/>

- 쿼럼은 설정가능하며 이는 센티넬의 수를 참조하여 마스터 다운될 때 동의해야 하는 수를 나타낸다.
- failover 시나리오에서 센티넬 인스턴스는 컨센서스를 맞추는 작업을 하고, 최소한 홀수개의 센티넬 인스턴스로 대부분의 문제를 해결할 수 있다. 
- 이 3개의 센티넬 인스턴스는 분리된 물리적 서버나 혹은 가상머신에 위치한다. 이들은 장애에 대해서 독립적으로 수행된다. 

### 장점

- 3개의 노드에서 당신은 완젼히 센티넬 배포를 구성할 수 있다. 
- 단순하게 이는 관리와 설정을 유지하게 한다. 
- 고가용성, Redis Sentinel 배포를 빌드하고, 특정 실패에 데해서 사람의 개입없이 회복하도록 한다. 
- 이는 단일 마스터 인스턴스를 최대한 유지하도록 하며, 모든 슬레이브 인스턴스가 장애가 생겨도 살아남을 수 있다. 
- 복수개의 슬레이브 노드는 마스터 노드로 부터 데이터를 복제한다. 

### 단점

- 확장이 안된다. 쓰기는 마스터로만 수행된다. 읽기/쓰기 분리 문제를 해결할 수 없다.
- 슬레이브는 읽기를 제공한다. 그러나 비동기 복제로 인해서 읽기 결과가 시간이 지난 경우가 발생할 수 있다. 
- 데이터 샤드를 지원하지 않는다. 마스터와 슬레이버 사용의 균형이 맞지 않을 수 있다. 
- 슬레이브 노드는 리소스의 낭비를 줄 수 있다. 백업 노드가 사용되지 않는경우 낭비가 된다. 
- Redis-Sentinel 은 반드시 클라이언트에 의해서 지원되어야한다. 클라이언트는 마법의 절반만 보유한다. 

![sentinel](https://miro.medium.com/max/924/0*ozni1acMIqpNyqfF)

## What is the Redis Cluster?

- Data는 자동적으로 여러 Redis 노드로 파티션 된다. 
- 안정적이고 신뢰도 있는 데이터 서비스를 제공한다. 
- 자동적으로 데이터를 여러 노드로 분산된다. 
- 클러스터는 반드시 최소 3개의 마스터 노드로 구성되어야 올바르게 동작한다. 
- Redis 는 최소한 하나의 슬레이브 노드가 있어야 하고 Redis 3.0 이상의 버젼이 필요하다. 

<br/>

- 각 노드는 2개의 TCP 커넥션을 오픈한다. 
- 표준 Redis TCP 포트는 클라이언트에 서비스한다. 두번째 포트는 클러스터 버스에 대해서 사용되며 이는 바이너리 프로토콜 기반의 노드간 통신을 수행한다. 

<br/>

- 만약 마스터 인스턴스가 불능은 네트워크 실패가 발생하거나 혹은 software/hardware 실패가 있는경우 발생하며, 다른 마스터 노드가 클러스터 버스를 통해 이를 인지하고 장애 조치 상태에 놓이게 된다. 
- 그리고 나서 불능한 마스터 노드를 대체할 적합한 슬레이브가 새로운 마스터 노드로 승격한다. 

### 장점

- 중앙화된 아키텍처가 없다. 자동적으로 여러 노드로 분산된다. 
- 데이터는 여러 노드로 분산되며 이때 해시 슬롯에 따라 수행된다. 데이터 분산은 동적으로 조정된다. 
- 확장성: 클러스터에 노드를 쉽게 넣고 뺄 수 있다. 노드들은 동적으로 추가/삭제가 되며 시스템은 1000노드로 확장될 수 있다. 
- 자동화된 장애복구는 스탠바이 데이터 복제를 이용하여 수행된다. 
- 마스터 슬레이브 구조를 지원하는 것 때문에 다른 추가적인 페일오버처리가 필요하지 않다. 이는 마스터의 내장된 페일오버를 가진다. 

### 단점

- 최소한 6대의 노드가 필요하며 3개의 마스터와 3개의 슬레이브가 필요하다. 
- 전체적으로 고가용성을 구성하지 않는다. 클러스터가 큰 장애에 놓이는 경우 마스터노드를 사용할 수 없는경우 클러스터가 멈추게 된다. 
- 데이터 복제는 비동기로 수행된다. 그리고 여기에는 데이터 일관성을 보장하지 않는다. 
- 복제 구조는 오직 하나의 레이어에서만 수행되기 때문에 슬레이브 노드는 오직 마스터노드의 복재만 할 수 있다. 
- 마스터들 사이에 샤드가 수행되기 때문에 클라이언트는 Redis Cluster에있는 모든 노드에 네트워크 접속이 필요하다. 만약 클라이언트가 데이터를 Master 1에 쓰기를 원하는데 데이터가 Master2에 있다면 Master 1은 클라이언트에게 이동 명령을 보내게 된다. Master 2로 요청을 보내라고 알려준다. 
- Redis클러스터를 지원하는 클라이언트 라이브러리가 모두 지원되지는 않는다. 
- 강력한 일관성을 지원하지 않는다. 실전에서 이 의미는 Redis Cluster 가 특정 상황에서 시스템이 클라이언트에 승인한 쓰기를 읽을 수 없을 수 있다. 
- 데이터 파티셔닝으로 데이터 처리가 복잡하게 된다. 예를 들어 복수개의 RDB/AOF 파일들을 다루어야 하는 경우와 호스트는 데이터 백업을 생성하는 경우 저장된 파일을 여러 인스턴스로 부터 집계해야할 필요가 있다. 이 의미는 단일 위치에 백업을 관리할 수없다는 의미가 된다. 

![cluster](https://miro.medium.com/max/1208/0*Z_3zLE5bGrOn3cMZ)

- 이번 아티클에서 다양한 redis 솔루션의 장점과 단점에 대해서 알아 보았다. 
- 여기에는 많은 팩터가 있으며 비즈니스 케이스에 따라 다양한 솔루션이 있다. 
- 다음 시나리오는 고려해야할 사항에 따른 선택이다.
  - Standalone사용: Redis를 테스트 용도로 사용하고자 하는 경우, 그러나 고가용성이 필요없는 경우 혹은 데이터 신뢰도가 필요없는 경우
  - Sentinel사용: 고 가용성이 필요한경우, 확장은 안되지만 머신의 램 보다 더 적은 데이터가 있는경우 사용 
  - Cluster사용:  샤딩이 필요하거나, 확장 및 자동 장애조치가 필요한경우, 완전한 고가용성은 필요 없고 서버의 RAM보다 더 많은 데이터가 있는경우 사용 